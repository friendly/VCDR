## Chapter 3

### Exercise 3.1 

The Arbuthnot data in HistData (Example 3.1) also contains the variable Ratio,
giving the ratio of male to female births.

a. Make a plot of `Ratio` over `Year`, similar to Figure 3.1. What features stand out? 
Which plot do you prefer to display the tendency for more male births?
```{r ex3.1a}
library(HistData)
data(Arbuthnot, package ="HistData")

# plot of Ratio by Year
par(mar=c(5,4,1,1)+.1)
with(Arbuthnot, {
  plot(Year, Ratio, type='b', ylim=c(.95, 1.2), 
       ylab="Birth Ratio (Male/Female)")
  abline(h=1, col="green", lwd=1)
  abline(h=mean(Ratio), col="red")
  text(x=1660, y=1, "Equal M/F ratio", pos=1, col="green3") 
  Arb.smooth <- loess.smooth(Year,Ratio)
  lines(Arb.smooth$x, Arb.smooth$y, col="blue", lwd=2)
})
summary(Arbuthnot$Ratio)

```

The plot is similar to Figure 3.1 in the text. If it is easier to think in terms of probability of a male birth,
plotting that directly may be preferable.

b. Plot the total number of christenings, `Males + Females` or `Total` (in 000s) over time.
What unusual features do you see?

```{r ex3.1b}
# total number of Christenings
with(Arbuthnot, {
  Total= Males + Females
  plot(Year, Total, type='b', ylab="Total Christenings (Male + Female)")
  Arb.smooth <- loess.smooth(Year,Total)
  lines(Arb.smooth$x, Arb.smooth$y, col="blue", lwd=2)
})
```

There was a large decline in births between 1640--1660, corresponding to years of plague in England.

### Exercise 3.2

Use the graphical methods illustrated in Section 3.2 to plot a collection of geometric distributions for $p$ = 0.2, 0.4, 0.6, 0.8, over a range of values of $k$ = 0, 1, ... 10.

a. With `xyplot()`, try the different plot formats using points connected with lines, as in Figure 3., or using points and lines down to the origin, as in the panels of Figure 3.10.

```{r ex3.2.a}
KL <- expand.grid(k = 0 : 10, p = c(0.2, 0.4, 0.6, 0.8))
geom_df <- data.frame(KL, prob = dgeom(KL$k, KL$p))
geom_df$p = factor(geom_df$p)
str(geom_df)

library(lattice)
mycol<-palette()[2:5]
xyplot(prob ~ k | p , data = geom_df, type = c("b"), 
       pch = 16, lwd = 4, cex = 1.25, 
       xlab = list("Number of events (k)", cex = 1.25), layout = c(2,2), 
       ylab = list("Probability", cex = 1.25))
xyplot(prob ~ k | p , data = geom_df, type = c("h", "p"), 
       pch = 16, lwd = 4, cex = 1.25, 
       xlab = list("Number of events (k)", cex = 1.25), layout = c(2,2), 
       ylab = list("Probability", cex = 1.25))
```

b. Also with `xyplot()`, produce one version of a multi-line plot in a single panel that you think shows well how these distributions change with the probability $p$ of success.

```{r ex3.2.b}
geomplt<-xyplot(prob ~ k , data = geom_df, groups = p, 
                type = c("b"), pch = 16, lwd = 4, cex = 1.25, col = mycol, 
                xlab = list("Number of events (k)", cex = 1.25), 
                ylab = list("Probability", cex = 1.25))
library(directlabels)
direct.label(geomplt, list("top.points", cex = 1.5, dl.trans(y = y + 0.1)))
```

c. Do the same in a multi-panel version, conditional on $p$

```{r ex3.2.c}
xyplot(prob ~ k | p , data = geom_df, type = c("b"), 
       pch = 16, lwd = 4, cex = 1.25, 
       xlab = list("Number of events (k)", cex = 1.25), layout = c(4,1), 
       ylab = list("Probability", cex = 1.25))
```

### Exercise 3.3

Use the data set `WomenQueue` to:

a. Produce plots analogous to those shown in Section 3.1 (some sort of bar graph of frequencies)
```{r ex3.3a}
data("WomenQueue", package = "vcd")
barplot(WomenQueue,xlab="Number of Women in queues of 10",ylab= "Frequency")
```

b. Check for goodness-of-fit to the binomial distribution using the `goodfit()` methods described
in Section 3.3.2.

Note that with `goodfit()`, you should specify $n=10$ for the binomial distribution as the `size` parameter.
```{r ex3.3b}
library(vcd)
gf.women <- goodfit(WomenQueue, type = "binomial", par=list(size=10))
summary(gf.women)

```

c. Make a reasonable plot showing departure from the binomial distribution.

The simplest plot is the hanging rootogram.  An alternative plot is a "binomialness" plot produced by `distplot()`.
```{r ex3.3c}
plot(gf.women, xlab = "Queue Length")
distplot(WomenQueue, type = "binomial", size=10, xlab = "Queue Length")
```

d. Suggest some reasons why the number of women in queues of length 10 might depart from a binomial distribution, $Bin(n=10, p=1/2)$.

- Perhaps women (or men) are more prevalent in these queues, so $p \ne 1/2$.
- People often join lines in groups, so the observations are unlikely to be independent.

### Exercise 3.4

Continue Example 3.13 on the distribution of male children in families in Saxony by fitting a binomial distribution, 
$Bin(n = 12; p = 1/2 )$, specifying equal probability for boys and girls. 

a. Carry out the GOF test for this fixed binomial distribution. What is the ratio of Chi-sqrare/df? What
do you conclude?

Note that you need to specify both $n$ and $p$ as fixed parameters here.
```{r ex3.4a}
Saxony_gf <-goodfit(Saxony, type = "binomial", par=list(size=12, prob=.5))
ss <-summary(Saxony_gf)
# The ratio of Chi-square/df
ss[,"X^2"] / ss[,"df"]
```
The binomial model fits very badly.

b. Test the additional lack of fit for the model Bin(n = 12; p = 1/2 ) compared to the model
$Bin(n = 12; p = \hat{p})$ where $\hat{p}$ is estimated from the data.

```{r ex3.4b}
Saxony_gf2 <- goodfit(Saxony, type = "binomial", par=list(size=12))
summary(Saxony_gf2)
```
This fits much better, but still not a good fit. 

c. Use the `plot.goodfit()` method to visualize these two models.

```{r ex3.4c}
plot(Saxony_gf, main = "Fit for p=0.5", xlab = "Number of Male Children (Out of 12)")
plot(Saxony_gf2, main = "Fit for p=phat", xlab = "Number of Male Children (Out of 12)")
```

### Exercise 3.5

For the `Federalist` data, the examples in Section 3.3.1 and Section 3.3.2 showed the negative binomial to provide an acceptable fit. Compare this with the simpler special case of geometric distribution, corresponding to $n = 1$.

a. Use `goodfit()` to fit the geometric distribution. [Hint: use `type="nbinomial"`, but specify `size=1` as a parameter.]

```{r ex3.5a}
fdfit1 <- goodfit(Federalist, type = "binomial", par = list(size=6))
fdfit1
fdfit2 <- goodfit(Federalist, type = "nbinomial", par = list(size=1))
fdfit2
```

b. Compare the negative binomial and the geometric models statistically, by a likelihood-ratio test of the difference between these two models.

<!--
```{r ex3.5b}
library(MASS)
block<-as.numeric(names(Federalist))
wordc<-as.vector(Federalist)
fd.df<-data.frame(block, wordc)
fd.df
fd.nbin <- glm.nb(wordc ~ block, method = "glm.fit", data = fd.df) #Does not converge, iteration limit reached
fd.geom <- glm(cbind(1, wordc)~ block, family = binomial, data = fd.df)
LRstats(fd.nbin, fd.geom)
```
-->

c. Compare the negative binomial and the geometric models visually by hanging rootograms or other methods.

```{r ex3.5.c}
plot(fdfit1)
plot(fdfit2)
distplot(Federalist, type = "binomial", size=6, xlab = "Word Count")
distplot(Federalist, type = "nbinomial", size=6, xlab = "Word Count")
```

### Exercise 3.6 

Mosteller and Wallace (1963, Table 2.4) give the frequencies, $n_k$, of counts $k =
0, 1, \dots$ of other selected marker words in 247 blocks of text known to have been written by Alexander Hamilton. The data below show the occurrences of the word *upon*, that Hamilton used much
more than did James Madison.

a. Read these data into R and construct a one-way table of frequencies of counts or a matrix or
data frame with frequencies in the first column and the corresponding counts in the second
column, suitable for use with `goodfit()`.

`goodfit()` requires its first argument to be either a one-way table (from `xtabs()`),
or a data.frame with frequencies in the *first* column and the corresponding counts in the second column.  Both of the following forms will work.
```{r upon1}
count <- 0:5
Freq <- c(129, 83, 20, 9, 5, 1)
sum(Freq)  # check N

(Upon <- data.frame(Freq, count))             # as a data.frame
(Upon.tab <- xtabs(Freq ~ count, data=Upon))  # one-way table

```

b. Fit and plot the Poisson model for these frequencies.
```{r upon2}
(up0 <- goodfit(Upon, type="poisson"))
summary(up0)
plot(up0)
```

c. Fit and plot the negative binomial model for these frequencies.
```{r}
(up1 <- goodfit(Upon, type="nbinomial"))
summary(up1)
plot(up1)
```

d. What do you conclude?

### Exercise 3.7

The data frame Geissler in the vcdExtra package contains the complete data from Geissler's (1889) tabulation of family sex composition in Saxony. The table  below gives the number of boys in families of size 11. 
```
boys   0   1    2    3     4     5     6     7     8   9   10   11 
Freq   8  72  275  837 1,540 2,161 2,310 1,801 1,077 492   93   24 
```

(a) Read these data into R.

See Exercise 2.6

(b) Following Example 3.13, use `goodfit()` to fit the binomial model and plot the results. Is there an indication that the binomial does not fit these data? 

(c) Diagnose the form of the distribution using the methods described in Section 3.4. 

(d) Try fitting the negative binomial distribution, and use `distplot()` to diagnose whether the negative binomial is a reasonable fit. 


### Exercise 3.8

The data frame `Bundesliga` gives a similar data set to that for UK soccer scores (UKSoccer) examined in Example 3.9, but over a wide range of years. The following lines calculate a two-way table, `BL1995`, of home-team and away-team goals for the 306 games in the year 1995.

```{r bundesliga}
data("Bundesliga", package = "vcd") 
BL1995 <-xtabs(~ HomeGoals + AwayGoals, data = Bundesliga, 
               subset = (Year == 1995))
BL1995 
```

(a) As in Example 3.9, find the one-way distributions of `HomeGoals`, `AwayGoals`, and `TotalGoals = HomeGoals + AwayGoals`. 

(b) Use `goodfit()` to fit and plot the Poisson distribution to each of these. Does the Poisson seem to provide a reasonable fit? 

(c) Use `distplot()` to assess fit of the Poisson distribution. 

(d) What circumstances of scoring goals in soccer might cause these distributions to deviate from Poisson distributions? 


### Exercise 3.9

Repeat the exercise above, this time using the data for all years in which there was the standard number (306) of games, that is for `Year>1965`, tabulated as shown below. 
```
BL <-xtabs(~ HomeGoals + AwayGoals, data = Bundesliga, 
           subset = (Year > 1965)) 
```


### Exercise 3.10

Using the data `CyclingDeaths` introduced in Example 3.6 and the one-way frequency table 
`CyclingDeaths.tab = table(CyclingDeaths$deaths)`, 

(a) Make a sensible plot of the number of deaths over time. For extra credit, add a smoothed curve (e.g., using `lines(lowess(...))`). 

(b) Test the goodness of fit of the table `CyclingDeaths.tab` to a Poisson distribution statistically using `goodfit()`. 

(c) Continue this analysis using a `rootogram()` and `distplot()`. 

(d) Write a one-paragraph summary of the results of these analyses and your conclusions. 


### Exercise 3.11

The one-way table, `Depends`, in vcdExtra [not] shown below gives the frequency distribution of the number of dependencies declared in 
4,983 R packages maintained on the CRAN distribution network on January 17, 2014. 
That is, there were 986 packages that had no dependencies, 1,347 packages that depended on one other package, ... up to 2 packages that depended on 14 other packages.

(a) Make a bar plot of this distribution. 

(b) Use `Ord_plot()` to see if this method can diagnose the form of the distribution. 

(c) Try to fit a reasonable distribution to describe dependencies among R packages. 


### Exercise 3.12

How many years does it take to get into the baseball Hall of Fame? The Lahman (Friendly, 2014b) package provides a complete record of historical baseball statistics from 1871 to the present. One table, `HallOfFame`, records the history of players nominated to the Baseball Hall of Fame, and those eventually inducted. 

The table [not shown] below, calculated in `help(HallOfFame, package="Lahman")`, records the distribution of the number of years taken (from first nomination) for the 109 players in the Hall of Fame to be inducted (1936--present). Note that `years==0` does not, and cannot, occur in this table, so the distribution is restricted to positive counts. 

Such distributions are called ___zero-truncated distributions___. 
Such distributions are like the ordinary ones, but with the probability of zero being zero. Thus the other probabilities are scaled up (i.e., divided by $1 - Pr(Y = 0)$) so they sum to 1.

(a) For the Poisson distribution, show that the zero-truncated probability function can be expressed in the form
$$
Pr({X = k | k > 0}) = \frac{1}{1-e^{-\lambda}} \times \frac{e^{-\lambda} \lambda^k}{k!}, k=1, 2, ...
$$

(b) Show that the mean is $\lambda/(1 - exp(-\lambda))$. 

(c) Enter these data into R as a one-way table, and use `goodfit()` to fit the standard Poisson distribution, as if you hadn't encountered the problem of zero truncation. 

